--// M-W FPS Panel Pro - ESP FIXED v2 (Box + Health Fixed)
--// by Miwa

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local localPlayer = Players.LocalPlayer

-- GUI Setup
local gui = Instance.new("ScreenGui")
gui.Name = "M-W_FPS_FixedV2"
gui.ResetOnSpawn = false
gui.Parent = game.CoreGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 280, 0, 260)
frame.Position = UDim2.new(0.05, 0, 0.25, 0)
frame.BackgroundColor3 = Color3.fromRGB(15,15,15)
frame.Active, frame.Draggable = true, true
frame.Parent = gui
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,10)

local title = Instance.new("TextLabel", frame)
title.Text = "M-W FPS Panel"
title.Size = UDim2.new(1,0,0,36)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextSize = 18
title.TextColor3 = Color3.fromRGB(0,200,255)

local minimize = Instance.new("TextButton", frame)
minimize.Text = "-"
minimize.Size = UDim2.new(0,34,0,30)
minimize.Position = UDim2.new(1,-40,0,3)
minimize.BackgroundColor3 = Color3.fromRGB(30,30,30)
minimize.Font = Enum.Font.GothamBold
minimize.TextSize = 18
minimize.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", minimize).CornerRadius = UDim.new(0,6)

local content = Instance.new("Frame", frame)
content.Size = UDim2.new(1,-12,1,-46)
content.Position = UDim2.new(0,6,0,40)
content.BackgroundTransparency = 1

local function makeButton(txt, y)
	local b = Instance.new("TextButton", content)
	b.Size = UDim2.new(1,0,0,36)
	b.Position = UDim2.new(0,0,0,(y-1)*40)
	b.BackgroundColor3 = Color3.fromRGB(35,35,35)
	b.TextColor3 = Color3.new(1,1,1)
	b.Font = Enum.Font.Gotham
	b.TextSize = 14
	b.Text = txt
	Instance.new("UICorner", b).CornerRadius = UDim.new(0,8)
	return b
end

local bEsp = makeButton("ESP Player : OFF",1)
local bBox = makeButton("ESP Box : OFF",2)
local bHp  = makeButton("ESP Health : OFF",3)
local bTeam= makeButton("Team Color : OFF",4)
local bDist= makeButton("ESP Distance : OFF",5)

local state = {
	esp=false, box=false, health=false, team=false, distance=false
}

local espData = {}

-- ESP Creation
local function createESP(plr)
	if plr==localPlayer or espData[plr] then return end
	local ch = plr.Character
	if not ch then return end
	local head = ch:FindFirstChild("Head")
	if not head then return end
	local hum = ch:FindFirstChildOfClass("Humanoid")
	local hrp = ch:FindFirstChild("HumanoidRootPart")
	if not hum or not hrp then return end

	local b = Instance.new("BillboardGui")
	b.Name = plr.Name.."_ESP"
	b.AlwaysOnTop = true
	b.Size = UDim2.new(0,200,0,250)
	b.Adornee = hrp
	b.ExtentsOffset = Vector3.new(0,2,0)
	b.Parent = gui

	local name = Instance.new("TextLabel", b)
	name.Size = UDim2.new(1,0,0,20)
	name.BackgroundTransparency = 1
	name.Font = Enum.Font.GothamBold
	name.TextSize = 14
	name.Text = plr.Name
	name.TextColor3 = Color3.fromRGB(0,255,255)

	local dist = Instance.new("TextLabel", b)
	dist.Size = UDim2.new(1,0,0,16)
	dist.Position = UDim2.new(0,0,1,-16)
	dist.BackgroundTransparency = 1
	dist.Font = Enum.Font.Gotham
	dist.TextSize = 12
	dist.TextColor3 = Color3.new(1,1,1)
	dist.Text = ""

	-- Box fix: uses Frame to draw around HRP bounds
	local box = Instance.new("Frame", b)
	box.Size = UDim2.new(0,80,0,120)
	box.AnchorPoint = Vector2.new(0.5,0.5)
	box.Position = UDim2.new(0.5,0,0.45,0)
	box.BackgroundTransparency = 1
	box.BorderSizePixel = 2
	box.BorderColor3 = Color3.fromRGB(0,255,255)
	box.Visible = state.box

	-- Health fix: visible bar left of box, scales properly
	local hpBg = Instance.new("Frame", b)
	hpBg.Size = UDim2.new(0,5,0,120)
	hpBg.AnchorPoint = Vector2.new(0,0.5)
	hpBg.Position = UDim2.new(0.5,-45,0.45,0)
	hpBg.BackgroundColor3 = Color3.fromRGB(50,50,50)
	hpBg.Visible = state.health
	hpBg.BorderSizePixel = 0

	local hpBar = Instance.new("Frame", hpBg)
	hpBar.Size = UDim2.new(1,0,1,0)
	hpBar.BackgroundColor3 = Color3.fromRGB(0,255,0)
	hpBar.BorderSizePixel = 0

	espData[plr]={gui=b,name=name,dist=dist,box=box,hpBg=hpBg,hpBar=hpBar,hum=hum,hrp=hrp}
end

local function destroyESP(plr)
	if espData[plr] then
		if espData[plr].gui then espData[plr].gui:Destroy() end
		espData[plr]=nil
	end
end

-- Update
RunService.RenderStepped:Connect(function()
	if not state.esp then return end
	local lhrp = localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart")
	for plr,data in pairs(espData) do
		local ch = plr.Character
		if not ch or not ch.Parent then destroyESP(plr) else
			local hum = data.hum
			if not hum then destroyESP(plr) else
				-- Color / Team
				if state.team and plr.Team and localPlayer.Team then
					if plr.Team==localPlayer.Team then
						data.name.TextColor3 = Color3.fromRGB(0,255,0)
						data.box.BorderColor3 = Color3.fromRGB(0,255,0)
					else
						data.name.TextColor3 = Color3.fromRGB(255,0,0)
						data.box.BorderColor3 = Color3.fromRGB(255,0,0)
					end
				else
					data.name.TextColor3 = Color3.fromRGB(0,255,255)
					data.box.BorderColor3 = Color3.fromRGB(0,255,255)
				end

				-- Health bar
				if state.health then
					local ratio = math.clamp(hum.Health / math.max(1,hum.MaxHealth),0,1)
					data.hpBg.Visible=true
					data.hpBar.Size=UDim2.new(1,0,ratio,0)
					data.hpBar.Position=UDim2.new(0,0,1-ratio,0)
					data.hpBar.BackgroundColor3 = Color3.fromRGB(255*(1-ratio),255*ratio,0)
				else
					data.hpBg.Visible=false
				end

				-- Box toggle
				data.box.Visible = state.box

				-- Distance
				if state.distance and lhrp then
					local dist = (lhrp.Position - data.hrp.Position).Magnitude
					data.dist.Text = string.format("[%.0f m]",dist)
					data.dist.Visible = true
				else
					data.dist.Visible=false
				end
			end
		end
	end
end)

-- Toggles
bEsp.MouseButton1Click:Connect(function()
	state.esp = not state.esp
	bEsp.Text = state.esp and "ESP Player : ON" or "ESP Player : OFF"
	if state.esp then
		for _,p in ipairs(Players:GetPlayers()) do
			if p~=localPlayer then createESP(p) end
		end
	else
		for p in pairs(espData) do destroyESP(p) end
	end
end)
bBox.MouseButton1Click:Connect(function()
	state.box = not state.box
	bBox.Text = state.box and "ESP Box : ON" or "ESP Box : OFF"
	for _,d in pairs(espData) do d.box.Visible = state.box end
end)
bHp.MouseButton1Click:Connect(function()
	state.health = not state.health
	bHp.Text = state.health and "ESP Health : ON" or "ESP Health : OFF"
	for _,d in pairs(espData) do d.hpBg.Visible = state.health end
end)
bTeam.MouseButton1Click:Connect(function()
	state.team = not state.team
	bTeam.Text = state.team and "Team Color : ON" or "Team Color : OFF"
end)
bDist.MouseButton1Click:Connect(function()
	state.distance = not state.distance
	bDist.Text = state.distance and "ESP Distance : ON" or "ESP Distance : OFF"
end)

Players.PlayerAdded:Connect(function(plr)
	plr.CharacterAdded:Connect(function()
		task.wait(1)
		if state.esp then createESP(plr) end
	end)
end)
Players.PlayerRemoving:Connect(function(plr)
	destroyESP(plr)
end)

-- Minimize
local minimized=false
minimize.MouseButton1Click:Connect(function()
	minimized=not minimized
	content.Visible=not minimized
	frame.Size = minimized and UDim2.new(0,150,0,40) or UDim2.new(0,280,0,260)
	minimize.Text = minimized and "+" or "-"
end)
